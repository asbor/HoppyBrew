name: PR Validation

on:
  pull_request:
    branches:
      - main
      - develop
      - "release/**"
  workflow_dispatch:

concurrency:
  group: pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  issues: write

jobs:
  backend-lint:
    name: Backend Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('services/backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ steps.setup-python.outputs.python-version }}-

      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install -r requirements.txt

      - name: Run flake8
        run: python -m flake8 .

  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: backend-lint
    defaults:
      run:
        working-directory: services/backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('services/backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ steps.setup-python.outputs.python-version }}-

      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install -r requirements.txt

      - name: Run pytest
        env:
          PYTHONPATH: ${{ github.workspace }}/services/backend
        run: pytest -q

      - name: Upload pytest cache (failure artefact)
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: backend-pytest-artifacts
          path: |
            services/backend/.pytest_cache
            services/backend/test_*.log
          if-no-files-found: ignore

  frontend-build:
    name: Frontend Build Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/nuxt3-shadcn
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: yarn
          cache-dependency-path: services/nuxt3-shadcn/yarn.lock

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Validate type generation
        run: yarn run generate

      - name: Build application
        run: yarn run build

  pr-report:
    name: MCP PR Intelligence
    runs-on: ubuntu-latest
    if: always()
    needs:
      - backend-lint
      - backend-tests
      - frontend-build
    steps:
      - name: Summarise job status
        id: summary
        uses: actions/github-script@v8
        with:
          script: |
            const jobs = {
              backendLint: '${{ needs.backend-lint.result }}',
              backendTests: '${{ needs.backend-tests.result }}',
              frontendBuild: '${{ needs.frontend-build.result }}',
            };

            const failedJobs = Object.entries(jobs)
              .filter(([, status]) => status !== 'success');

            const tableRows = Object.entries(jobs)
              .map(([name, status]) => `| ${name} | ${status} |`)
              .join('\n');

            const summary = [
              '### CI Quality Gate Summary',
              '',
              '| Check | Result |',
              '| --- | --- |',
              tableRows,
              '',
              failedJobs.length
                ? `:x: ${failedJobs.length} stage(s) require attention.`
                : ':white_check_mark: All quality gates passed.',
            ].join('\n');

            core.setOutput('markdown', summary);
            core.setOutput('failed', failedJobs.length > 0 ? 'true' : 'false');

      - name: Update PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const marker = '<!-- ci-pr-validation-report -->';
            const body = `${marker}\n${core.getInput('markdown')}`;
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
            });

            const existing = comments.find(
              (comment) =>
                comment.user?.login === 'github-actions[bot]' &&
                comment.body?.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
          markdown: ${{ steps.summary.outputs.markdown }}

      - name: "MCP: Publish PR analytics"
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        env:
          MCP_SERVER_URL: ${{ secrets.MCP_SERVER_URL }}
          MCP_API_KEY: ${{ secrets.MCP_API_KEY }}
        with:
          script: |
            const url = process.env.MCP_SERVER_URL;
            if (!url) {
              core.info('MCP server URL not configured; skipping analytics dispatch.');
              return;
            }

            const payload = {
              repository: context.repo,
              workflow: 'pr-validation',
              pull_request: context.payload.pull_request?.number,
              summary: core.getInput('summary'),
              checks: {
                backendLint: '${{ needs.backend-lint.result }}',
                backendTests: '${{ needs.backend-tests.result }}',
                frontendBuild: '${{ needs.frontend-build.result }}',
              },
              conclusion: '${{ job.status }}',
            };

            const response = await fetch(`${url.replace(/\/$/, '')}/github/pr-insights`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(process.env.MCP_API_KEY ? { Authorization: `Bearer ${process.env.MCP_API_KEY}` } : {}),
              },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              core.setFailed(`Failed to publish MCP analytics: ${response.status} ${response.statusText}`);
            } else {
              core.info('MCP analytics dispatched successfully.');
            }
          summary: ${{ steps.summary.outputs.markdown }}

      - name: "MCP: Auto-create CI failure issue"
        if: github.event_name == 'pull_request' && steps.summary.outputs.failed == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const markerLabel = 'ci-failure';
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;
            const title = `CI failure on PR #${prNumber}`;
            const body = [
              'Automated MCP alert for PR validation failure.',
              '',
              core.getInput('markdown'),
              '',
              '_Generated by CI pipeline via MCP integration._',
            ].join('\n');

            const { data: existing } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} "${title}" in:title state:open label:${markerLabel}`,
            });

            if (existing.total_count > 0) {
              core.info('Open CI failure issue already exists; skipping creation.');
              return;
            }

            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: [markerLabel, 'automated'],
            });
          markdown: ${{ steps.summary.outputs.markdown }}

      - name: Fail workflow if any job failed
        if: steps.summary.outputs.failed == 'true'
        run: |
          echo "One or more PR validation jobs failed. Check the summary above for details."
          exit 1
