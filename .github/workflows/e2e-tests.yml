name: E2E Tests (Playwright)

on:
    push:
        branches:
            - main
            - develop
            - "feature/**"
            - "bugfix/**"
            - "agent/**"
        paths:
            - "services/nuxt3-shadcn/**"
            - ".github/workflows/e2e-tests.yml"
    pull_request:
        paths:
            - "services/nuxt3-shadcn/**"
            - ".github/workflows/e2e-tests.yml"
    workflow_dispatch:

concurrency:
    group: e2e-tests-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read
    checks: write

jobs:
    e2e-tests:
        name: E2E Tests
        runs-on: ubuntu-latest
        timeout-minutes: 30

        strategy:
            fail-fast: false
            matrix:
                browser: [chromium, firefox, webkit]

        defaults:
            run:
                working-directory: services/nuxt3-shadcn

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: npm
                  cache-dependency-path: services/nuxt3-shadcn/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Install Playwright browsers
              run: npx playwright install ${{ matrix.browser }}

            - name: Install system dependencies
              run: npx playwright install-deps ${{ matrix.browser }}

            - name: Set up backend service
              run: |
                  # Start backend in background for E2E tests
                  cd ../backend
                  pip install -r requirements.txt
                  python -m pytest --version # Ensure backend dependencies work
                  nohup python main.py &
                  echo "Backend started"

                  # Wait for backend to be ready
                  timeout 60 bash -c 'until curl -f http://localhost:5000/health || curl -f http://localhost:8000/health; do sleep 2; done'
              env:
                  PYTHONPATH: ${{ github.workspace }}/services/backend

            - name: Run Playwright tests
              run: npx playwright test --project=${{ matrix.browser }}
              env:
                  CI: true

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: playwright-results-${{ matrix.browser }}
                  path: |
                      services/nuxt3-shadcn/test-results/
                      services/nuxt3-shadcn/playwright-report/
                  retention-days: 7

            - name: Upload Playwright HTML report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: playwright-report-${{ matrix.browser }}
                  path: services/nuxt3-shadcn/playwright-report/
                  retention-days: 7

    mobile-e2e:
        name: Mobile E2E Tests
        runs-on: ubuntu-latest
        timeout-minutes: 25

        defaults:
            run:
                working-directory: services/nuxt3-shadcn

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: npm
                  cache-dependency-path: services/nuxt3-shadcn/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Install Playwright browsers
              run: npx playwright install chromium

            - name: Install system dependencies
              run: npx playwright install-deps chromium

            - name: Set up backend service
              run: |
                  # Start backend in background for mobile tests
                  cd ../backend
                  pip install -r requirements.txt
                  nohup python main.py &
                  echo "Backend started for mobile tests"

                  # Wait for backend to be ready
                  timeout 60 bash -c 'until curl -f http://localhost:5000/health || curl -f http://localhost:8000/health; do sleep 2; done'
              env:
                  PYTHONPATH: ${{ github.workspace }}/services/backend

            - name: Run mobile Playwright tests
              run: npx playwright test --project="Mobile Chrome" --project="Mobile Safari"
              env:
                  CI: true

            - name: Upload mobile test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: playwright-mobile-results
                  path: |
                      services/nuxt3-shadcn/test-results/
                      services/nuxt3-shadcn/playwright-report/
                  retention-days: 7
